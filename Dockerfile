# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ง BASE DE LA IMAGEN                         โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
FROM alpine

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ง INSTALACIรN Y CONFIGURACIรN               โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
RUN apk update && apk add --no-cache \
    nodejs gcc g++ cmake make tmux dropbear bash linux-headers && \
    echo -e "/bin/false\n/usr/sbin/nologin\n" >> /etc/shells && \
    adduser -DH toji -s /bin/false && \
    echo -e "toji:fushiguro" | chpasswd

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ฆ OPCIONAL: SOPORTE PARA STUNNEL (comentado)         โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#WORKDIR /etc/stunnel
#RUN openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -sha256 -days 3650 -nodes -subj "/C=AR/ST=Tierra del Fuego/L=Usuahia/O=Common LLC/OU=Common LLC/CN=localhost"
#RUN cat key.pem cert.pem > stunnel.pem

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ ARCHIVOS DE TRABAJO                       โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
WORKDIR /workdir
COPY badvpn-src/ ./badvpn-src
COPY proxy3.js ./
#COPY stunnel.conf /etc/stunnel
COPY run.sh ./

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ โ๏ธ COMPILACIรN DE BADVPN                     โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
WORKDIR /workdir/badvpn-src
RUN mkdir -p build
WORKDIR /workdir/badvpn-src/build
RUN cmake .. -DBUILD_NOTHING_BY_DEFAULT=1 -DBUILD_TUN2SOCKS=1 -DBUILD_UDPGW=1 -DCMAKE_BUILD_TYPE=Release && \
    make -j2 install

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐งน LIMPIEZA FINAL                            โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
WORKDIR /workdir
RUN rm -rf badvpn-src && chmod +x /workdir/run.sh

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ช PUERTO EXPUESTO                          โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
EXPOSE 8080

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ COMANDO DE EJECUCIรN                     โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
CMD ./run.sh
